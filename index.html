<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Metas Escolares com Ranking</title>
    <style>
        /* Estilos gerais */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* Container principal */
        .calculator-container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        /* Estilo das abas */
        .tabs {
            display: flex;
            background-color: #00796b;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .tabs::-webkit-scrollbar { display: none; }

        .tab-link {
            background-color: transparent;
            color: white;
            border: none;
            padding: 14px 18px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s, color 0.3s;
            flex-shrink: 0;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-link:hover { background-color: #00897b; }
        .tab-link.active {
            border-bottom: 3px solid #ffffff;
            font-weight: 600;
        }

        /* Conte√∫do das abas */
        .tab-content {
            display: none;
            padding: 25px 30px;
            animation: fadeIn 0.4s;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 { margin-top: 0; color: #333; font-size: 22px; }
        h3 { margin-top: 25px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #00796b;}

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 15px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .calculate-btn, .action-btn {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
            background-color: #26a69a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .calculate-btn:hover, .action-btn:hover { background-color: #00897b; }

        .result {
            margin-top: 20px;
            padding: 18px;
            background-color: #e0f2f1;
            border-left: 5px solid #00796b;
            border-radius: 0 8px 8px 0;
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            min-height: 25px;
            color: #004d40;
        }
        
        /* Estilos para turmas */
        .turma-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        .turma-grid strong { font-size: 13px; color: #555; }
        .turma-grid label { font-weight: 600; color: #333; }
        .turma-grid input { padding: 8px; font-size: 14px; text-align: center; }
        .turma-meta, .turma-result { font-weight: bold; text-align: center; }
        .turma-meta { color: #ef6c00; }
        .turma-result { color: #00796b; }

        /* Estilos para Configura√ß√µes */
        .settings-form { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: flex-end; }
        .delete-btn {
            background-color: #e53935; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 8px; font-size: 12px;
        }
        .turma-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 5px; }
        .turma-list-item:nth-child(odd) { background-color: #f9f9f9; }

        /* Estilos para Ranking */
        .ranking-container {
            margin-top: 25px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .ranking-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            text-align: center;
            color: #333;
        }
        .ranking-container ol {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .ranking-container li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .ranking-container li:nth-child(odd) {
            background-color: #f7f7f7;
        }
        .ranking-container li strong {
            color: #333;
        }
        .ranking-container li:nth-child(1)::before { content: 'ü•á '; font-size: 20px; }
        .ranking-container li:nth-child(2)::before { content: 'ü•à '; font-size: 20px; }
        .ranking-container li:nth-child(3)::before { content: 'ü•â '; font-size: 20px; }
        .ranking-container li:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3))::before {
            content: attr(data-rank)'. ';
            font-weight: bold;
            min-width: 25px;
        }
    </style>
</head>
<body>

<div class="calculator-container">
    <div class="tabs">
        <button class="tab-link active" data-tab="settings">‚öôÔ∏è Configura√ß√µes & Turmas</button>
        <button class="tab-link" data-tab="ensinoMedio">ENSINO M√âDIO</button>
        <button class="tab-link" data-tab="ei2Manha">E.I. ao 2¬∞ ANO (M)</button>
        <button class="tab-link" data-tab="ei2Tarde">E.I. ao 2¬∞ ANO (T)</button>
        <button class="tab-link" data-tab="ef1Manha">E.F. I (M)</button>
        <button class="tab-link" data-tab="ef1Tarde">E.F. I (T)</button>
        <button class="tab-link" data-tab="ef2Manha">E.F. II (M)</button>
        <button class="tab-link" data-tab="ef2Tarde">E.F. II (T)</button>
    </div>

    <!-- Aba de Configura√ß√µes -->
    <div id="settings" class="tab-content active">
        <h2>Configura√ß√µes Gerais e Gerenciamento de Turmas</h2>
        <div class="form-group">
            <label for="metaPerStudent">Meta de itens por aluno:</label>
            <input type="number" id="metaPerStudent" value="5" min="1">
        </div>
        <hr>
        <h3>Adicionar Nova Turma</h3>
        <div class="settings-form">
            <div class="form-group">
                <label for="newTurmaSegment">Se√ß√£o</label>
                <select id="newTurmaSegment"></select>
            </div>
            <div class="form-group">
                <label for="newTurmaName">Nome da Turma</label>
                <input type="text" id="newTurmaName" placeholder="Ex: EM1MA">
            </div>
            <div class="form-group">
                <label for="newTurmaStudents">N¬∞ de Alunos</label>
                <input type="number" id="newTurmaStudents" placeholder="Ex: 25">
            </div>
            <button id="addTurmaBtn" class="action-btn" style="padding: 12px; font-size: 16px;">Adicionar</button>
        </div>

        <div id="turmasListContainer">
            <!-- Listas de turmas por se√ß√£o ser√£o inseridas aqui -->
        </div>
    </div>

    <!-- Abas de Segmentos -->
    <div id="ensinoMedio" class="tab-content"></div>
    <div id="ei2Manha" class="tab-content"></div>
    <div id="ei2Tarde" class="tab-content"></div>
    <div id="ef1Manha" class="tab-content"></div>
    <div id="ef1Tarde" class="tab-content"></div>
    <div id="ef2Manha" class="tab-content"></div>
    <div id="ef2Tarde" class="tab-content"></div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('.calculator-container');
    const localStorageKey = 'metasEscolaresApp';

    const segments = {
        ensinoMedio: 'ENSINO M√âDIO',
        ei2Manha: 'E.I. ao 2¬∞ ANO (MANH√É)',
        ei2Tarde: 'E.I. ao 2¬∞ ANO (TARDE)',
        ef1Manha: 'E.F. I (MANH√É)',
        ef1Tarde: 'E.F. I (TARDE)',
        ef2Manha: 'E.F. II (MANH√É)',
        ef2Tarde: 'E.F. II (TARDE)'
    };

    // Estrutura de dados padr√£o
    const createDefaultState = () => ({
        metaPerStudent: 5,
        turmas: {
            ensinoMedio: [], ei2Manha: [], ei2Tarde: [],
            ef1Manha: [], ef1Tarde: [], ef2Manha: [], ef2Tarde: []
        }
    });

    let state = JSON.parse(localStorage.getItem(localStorageKey)) || createDefaultState();

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
    const formatResult = (num) => num.toLocaleString('pt-BR', { maximumFractionDigits: 2 });

    function renderAll() {
        renderSettings();
        for (const segmentId in segments) {
            renderSegmentTab(segmentId);
        }
    }

    function renderSettings() {
        document.getElementById('metaPerStudent').value = state.metaPerStudent;
        
        const select = document.getElementById('newTurmaSegment');
        select.innerHTML = Object.keys(segments).map(id => `<option value="${id}">${segments[id]}</option>`).join('');

        const listContainer = document.getElementById('turmasListContainer');
        listContainer.innerHTML = '';
        for (const segmentId in segments) {
            if (state.turmas[segmentId].length > 0) {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `<h3>${segments[segmentId]}</h3>`;
                state.turmas[segmentId].forEach(turma => {
                    sectionDiv.innerHTML += `
                        <div class="turma-list-item">
                            <span><strong>${turma.name}</strong> - ${turma.students} alunos</span>
                            <button class="delete-btn" data-segment="${segmentId}" data-turma="${turma.name}">Excluir</button>
                        </div>
                    `;
                });
                listContainer.appendChild(sectionDiv);
            }
        }
    }

    function renderSegmentTab(segmentId) {
        const tabContent = document.getElementById(segmentId);
        if (!tabContent) return;

        let html = `<h2>Metas - ${segments[segmentId]}</h2>`;
        const turmas = state.turmas[segmentId];

        if (turmas.length > 0) {
            html += `
                <div class="turma-grid">
                    <strong>Turma</strong>
                    <strong>Alunos</strong>
                    <strong>Itens Arrecadados</strong>
                    <strong>Meta da Turma</strong>
                    <strong>Progresso</strong>
                </div>
            `;
            turmas.forEach(turma => {
                const meta = turma.students * state.metaPerStudent;
                const progresso = meta > 0 ? (turma.collected / meta) * 100 : 0;
                html += `
                    <div class="turma-grid">
                        <label>${turma.name}</label>
                        <div class="turma-students">${turma.students}</div>
                        <input type="number" class="turma-collected-input" data-segment="${segmentId}" data-turma="${turma.name}" value="${turma.collected || ''}" placeholder="Qtd.">
                        <div class="turma-meta">${formatResult(meta)}</div>
                        <div class="turma-result">${formatResult(progresso)}%</div>
                    </div>
                `;
            });
            html += `<button class="calculate-btn" data-calc="${segmentId}">Calcular Progresso</button>`;
            html += `<div class="result" id="${segmentId}-total-result"></div>`;
            html += `<div class="ranking-container" id="${segmentId}-ranking"></div>`; // Placeholder para o ranking
        } else {
            html += `<p>Nenhuma turma adicionada para esta se√ß√£o. Adicione turmas na aba "‚öôÔ∏è Configura√ß√µes & Turmas".</p>`;
        }
        tabContent.innerHTML = html;
    }

    // --- FUN√á√ïES DE L√ìGICA E ESTADO ---
    function saveState() {
        localStorage.setItem(localStorageKey, JSON.stringify(state));
    }

    function addTurma() {
        const segmentId = document.getElementById('newTurmaSegment').value;
        const name = document.getElementById('newTurmaName').value.trim().toUpperCase();
        const students = parseInt(document.getElementById('newTurmaStudents').value, 10);

        if (!name || isNaN(students) || students <= 0) {
            alert('Por favor, preencha o nome da turma e um n√∫mero v√°lido de alunos.');
            return;
        }
        
        if (state.turmas[segmentId].some(t => t.name === name)) {
            alert('J√° existe uma turma com este nome nesta se√ß√£o.');
            return;
        }

        state.turmas[segmentId].push({ name, students, collected: 0 });
        saveState();
        renderAll();

        document.getElementById('newTurmaName').value = '';
        document.getElementById('newTurmaStudents').value = '';
    }

    function deleteTurma(segmentId, turmaName) {
        if (confirm(`Tem certeza que deseja excluir a turma ${turmaName}?`)) {
            state.turmas[segmentId] = state.turmas[segmentId].filter(t => t.name !== turmaName);
            saveState();
            renderAll();
        }
    }

    function calculateSegmentProgress(segmentId) {
        let totalArrecadado = 0;
        let totalMeta = 0;

        // 1. Atualiza o estado com os valores dos inputs
        state.turmas[segmentId].forEach(turma => {
            const input = document.querySelector(`.turma-collected-input[data-turma="${turma.name}"][data-segment="${segmentId}"]`);
            turma.collected = parseFloat(input.value) || 0;
        });
        
        saveState(); 
        renderSegmentTab(segmentId); // Re-renderiza a aba para mostrar os percentuais individuais atualizados

        // 2. Calcula o total para o resultado geral da se√ß√£o
        state.turmas[segmentId].forEach(turma => {
            totalArrecadado += turma.collected;
            totalMeta += turma.students * state.metaPerStudent;
        });

        const totalResultDiv = document.getElementById(`${segmentId}-total-result`);
        if (totalMeta > 0) {
            const totalPercentage = (totalArrecadado / totalMeta) * 100;
            totalResultDiv.innerHTML = `Progresso Total (${segments[segmentId]}): <b>${formatResult(totalPercentage)}%</b> <br>(${formatResult(totalArrecadado)} de ${formatResult(totalMeta)} itens)`;
        } else {
            totalResultDiv.innerHTML = '';
        }

        // 3. Gera e exibe o Ranking
        renderRanking(segmentId);
    }

    function renderRanking(segmentId) {
        const rankingContainer = document.getElementById(`${segmentId}-ranking`);
        if (!rankingContainer) return;

        // Cria um array tempor√°rio com os dados para o ranking
        const rankingData = state.turmas[segmentId].map(turma => {
            const meta = turma.students * state.metaPerStudent;
            const percentage = meta > 0 ? (turma.collected / meta) * 100 : 0;
            return { name: turma.name, percentage: percentage };
        });

        // Ordena o array da maior para a menor porcentagem
        rankingData.sort((a, b) => b.percentage - a.percentage);

        // Gera o HTML do ranking
        let rankingHtml = '<h3>üèÜ Ranking da Se√ß√£o</h3>';
        if (rankingData.length > 0) {
            rankingHtml += '<ol>';
            rankingData.forEach((turma, index) => {
                rankingHtml += `<li data-rank="${index + 1}">
                                    <strong>${turma.name}</strong>
                                    <span>${formatResult(turma.percentage)}%</span>
                                </li>`;
            });
            rankingHtml += '</ol>';
        } else {
            rankingHtml += '<p>Nenhuma turma para rankear.</p>';
        }
        
        rankingContainer.innerHTML = rankingHtml;
    }

    // --- EVENT LISTENERS ---
    container.addEventListener('click', (event) => {
        const target = event.target;
        if (target.matches('.tab-link')) {
            container.querySelector('.tab-link.active')?.classList.remove('active');
            container.querySelector('.tab-content.active')?.classList.remove('active');
            target.classList.add('active');
            container.querySelector(`#${target.dataset.tab}`).classList.add('active');
        }
        if (target.matches('.delete-btn')) {
            deleteTurma(target.dataset.segment, target.dataset.turma);
        }
        if (target.matches('.calculate-btn')) {
            calculateSegmentProgress(target.dataset.calc);
        }
    });

    document.getElementById('addTurmaBtn').addEventListener('click', addTurma);
    document.getElementById('metaPerStudent').addEventListener('change', (e) => {
        state.metaPerStudent = parseFloat(e.target.value) || 1;
        saveState();
        renderAll();
    });
    
    // --- INICIALIZA√á√ÉO ---
    renderAll();
});
</script>

</body>
</html>
